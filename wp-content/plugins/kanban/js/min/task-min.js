function Task(e){this.record=e,this.build_el()}Task.prototype.board=function(){return boards[this.record.board_id]},Task.prototype.add_to_board=function(){var e=$("#status-{0}-tasks".sprintf(this.record.status_id));this.$el.prependTo(e)},Task.prototype.build_el=function(){this.record.status=this.board().record.status_records()[this.record.status_id]?this.board().record.status_records()[this.record.status_id]:{},this.record.project=this.board().record.project_records[this.record.project_id]?this.board().record.project_records[this.record.project_id]:{},this.record.estimate=this.board().record.estimate_records()[this.record.estimate_id]?this.board().record.estimate_records()[this.record.estimate_id]:{},this.record.user_assigned=this.board().record.allowed_users()[this.record.user_id_assigned]?this.board().record.allowed_users()[this.record.user_id_assigned]:{},this.record.hour_count_formatted=format_hours(this.record.hour_count);var e=templates[this.board().record.id()]["t-task"].render({task:this.record,estimate_records:obj_order_by_prop(this.board().record.estimate_records(),"position"),project_records:this.board().record.project_records,allowed_users:this.board().record.allowed_users(),current_user_can_write:this.board().current_user().has_cap("write")});this.$el=$(e),encode_urls_emails($(".task-title",this.$el)),this.dom(),$(document).trigger("/task/added/",this)},Task.prototype.dom=function(){var self=this;return self.update_progress(),self.board().current_user().has_cap("write")?(self.$el.on("click",".btn-task-delete",function(){var e=$(this);return $(".glyphicon",e).show(),self["delete"](),!1}),self.$el.on("shown.bs.dropdown",".dropdown",function(){var e=$(this);$(".task.active",self.board().$el).not(self.$el).removeClass("active"),self.$el.addClass("active")}).on("hidden.bs.dropdown",function(){self.$el.removeClass("active")}),self.$el.on("show.bs.dropdown",".task-project",function(){var e=$(this),r=$(".dropdown-menu",e).empty(),t=0;for(var o in self.board().record.project_records){var s=self.board().record.project_records[o],a=templates[self.board().record.id()]["t-task-project-dropdown"].render(s);$(a).prependTo(r),t++}return 0==t?!1:void 0}).on("hide.bs.dropdown",".task-project",function(){var e=$(this),r=$("[contenteditable]",e);return r.is(":focus")?!1:void 0}).on("keydown",".task-project [contenteditable]",function(e){var r=$(this),t=r.closest(".dropdown");if(27===e.keyCode){var o=r.data("orig");return r.html(o),r.blur(),clearTimeout(r.data("save_timer")),void(t.hasClass("open")&&t.removeClass("open"))}return 13===e.keyCode?(r.blur(),void(t.hasClass("open")&&t.removeClass("open"))):32===e.keyCode?(r.html(r.html()+"&nbsp;"),placeCaretAtEnd(r.get(0)),!1):void 0}).on("blur",".task-project [contenteditable]",function(){if(window.getSelection().removeAllRanges(),!self.board().current_user().has_cap("write"))return!1;var e=setTimeout(function(){self.parse_project()},100);$(this).data("save_timer",e)}).on("focus",".task-project [contenteditable]",function(){if(!self.board().current_user().has_cap("write"))return!1;var e=$(this);e.data("orig",e.text())}),self.$el.on("click",".btn-project-assign",function(){var e=$(this),r=e.closest(".dropdown"),t=$("[contenteditable]",r);clearTimeout(t.data("save_timer"));var o=e.attr("data-id");self.project_save(o)}),self.$el.on("focus",".task-title",function(e){if(!self.board().current_user().has_cap("write"))return!1;var r=$(this);return $(e.target).is("a")?!1:(r.data("orig",r.html()),void strip_tags(r))}).on("keydown",".task-title",function(e){if(!self.board().current_user().has_cap("write"))return!1;var r=$(this);if(27===e.keyCode){var t=r.data("orig");return r.html(t),void r.blur()}return 13!==e.keyCode||e.shiftKey?void 0:void r.blur()}).on("keyup",".task-title",function(){if(!self.board().current_user().has_cap("write"))return!1;var e=$(this);clearTimeout(e.data("save_timer"));var r=setTimeout(function(){self.save_title()},3e3);e.data("save_timer",r)}).on("blur",".task-title",function(){return window.getSelection().removeAllRanges(),self.board().current_user().has_cap("write")?void self.save_title():!1}),self.$el.on("mouseenter",".btn-task-action",function(){var e=$(this),r=e.closest(".dropdown");if(r.is(".open"))return!1;var t=setTimeout(function(){return r.is(".open")?!1:void e.trigger("click")},500);e.data("timer-open",t)}).on("mouseleave",".btn-task-action",function(){var e=$(this),r=e.closest(".dropdown");if(clearTimeout(e.data("timer-open")),r.is(".open")){var t=setTimeout(function(){r.removeClass("open")},500);r.data("timer-close",t)}}).on("mouseenter",".dropdown-menu",function(){var e=$(this),r=e.closest(".dropdown");clearTimeout(r.data("timer-close"))}),self.$el.on("show.bs.dropdown",".row-task-actions .dropdown",function(e){var r=$(e.relatedTarget),t=r.closest(".dropdown"),o=$(".dropdown-menu",t);o.css("maxWidth",self.$el.outerWidth())}),self.$el.on("click",".btn-task-move",function(){var e=$(this),r=e.attr("data-target"),t=$(r);$(".task-id",t).val(self.record.id),$(".task-title",t).html(self.record.title)}),self.$el.on("click",".btn-task-estimate",function(){var e=$(this),r=e.attr("data-id"),t=self.board().record.estimate_records()[r],o=text.task_estimate_updated.sprintf(self.board().current_user().record().short_name,t.title);if("undefined"!=typeof self.board().record.estimate_records()[self.record.estimate_id]){var s=self.board().record.estimate_records()[self.record.estimate_id];if(r==self.record.estimate_id)return!0;o+=text.task_estimate_updated_previous.sprintf(s.title)}self.record.estimate_id=r,self.save(o),$(".task-estimate",self.$el).html(t.title),self.update_progress()}),self.$el.on("click",".btn-task-assigned",function(){var e=$(this),r=e.attr("data-id");if(r==self.record.user_id_assigned)return!0;var t=self.board().record.allowed_users()[r],o=text.task_assigned_to.sprintf(self.board().current_user().record().short_name,t.short_name);if("undefined"!=typeof self.board().record.allowed_users()[self.record.user_id_assigned]){var s=self.board().record.allowed_users()[self.record.user_id_assigned];if(r==self.record.user_id_assigned)return!0;o+=text.task_assigned_to_previous.sprintf(s.short_name)}self.record.user_id_assigned=r,self.save(o),self.update_assigned_to(r)}),void self.$el.on("click",".btn-task-hour",function(){var $btn=$(this),operator=$btn.attr("data-operator");if("+"!=operator&&"-"!=operator)return!1;var current="undefined"!=typeof self.record.hour_count?parseFloat(self.record.hour_count):0,interval=self.board().record.settings().hour_interval;return current=eval(current+operator+interval),current=Math.round(1e3*current)/1e3,0>current&&(current=0),self.record.hour_count=current,$(".task-hours",self.$el).html(format_hours(self.record.hour_count)),self.update_progress(),self.log_work_hour(operator),!1})):!1},Task.prototype.update_progress=function(){var e=0;if("undefined"!=typeof this.record.estimate_id||"undefined"!=typeof this.record.hour_count){var r=this.board().record.estimate_records()[this.record.estimate_id];if("undefined"!=typeof r){e=100*parseFloat(this.record.hour_count)/parseFloat(r.hours);var t="success";e>133?t="danger":e>100&&(t="warning"),e>100&&(e=100),$(".progress-bar",this.$el).css({width:e+"%"}).removeClass("progress-bar-success progress-bar-warning progress-bar-danger").addClass("progress-bar-"+t)}}},Task.prototype.save=function(e,r){if(!this.board().current_user().has_cap("write"))return!1;var t=this,o={task:this.record,action:"save_task",kanban_nonce:$("#kanban_nonce").val()};"undefined"!=typeof e&&null!==e&&""!==e&&(o.comment=e),"undefined"==typeof r&&(r=!0),o.message=r,$.ajax({method:"POST",url:ajaxurl,data:o}).done(function(e){return e.success?void t.board().update_UI():(growl(text.task_save_error),!1)})},Task.prototype["delete"]=function(e){if(!this.board().current_user().has_cap("write"))return!1;var r=this,t={task:this.record,action:"delete_task",kanban_nonce:$("#kanban_nonce").val(),comment:text.task_deleted.sprintf(r.board().current_user().record().short_name)};$.ajax({method:"POST",url:ajaxurl,data:t}).done(function(e){return e.success?($(document).trigger("/task/deleted/",r),void r.delete_el()):(growl(text.task_delete_error),!1)})},Task.prototype.delete_el=function(){var e=this;e.$el.slideUp("fast",function(){e.$el.remove(),e.board().update_UI(),e.board().update_task_positions(),delete e.board().record.tasks[e.record.id]})},Task.prototype.update_status=function(e){if(!this.board().current_user().has_cap("write"))return!1;var r=this.board().record.status_records()[e];$(".task-handle",this.$el).css({background:r.color_hex})},Task.prototype.update_position=function(e){if(!this.board().current_user().has_cap("write"))return!1;if(e==this.record.position)return!1;e=parseInt(e);var r=this.record.position+"",t=text.task_moved_to_position.sprintf(this.board().current_user().record().short_name,e);""!==r&&(t+=text.task_moved_to_position_previous.sprintf(parseInt(r))),this.record.position=e,this.save(t,!1)},Task.prototype.update_assigned_to=function(e){if(!this.board().current_user().has_cap("write"))return!1;var r=this,t=r.board().record.allowed_users()[e];r.$el.attr("data-user_id-assigned",e);var o=$(".task-assigned-initials",r.$el).removeClass("empty");"undefined"!=typeof t.avatar?o.html(t.avatar):o.text(t.initials),$(".task-assigned-name",r.$el).text(t.short_name)},Task.prototype.save_title=function(){var e=$(".task-title",this.$el);clearTimeout(e.data("save_timer"));var r=this.record.title+"";sanitize(e);var t=e.html().replace(/\\/gi,"&#92;"),o=text.task_title_updated.sprintf(this.board().current_user().record().short_name,t);""!==r&&(o+=text.task_title_updated_previous.sprintf(r)),""!==t&&t!==r||(o=null),this.record.title=t,this.save(o),encode_urls_emails(e)},Task.prototype.project_update_title=function(e){$(".task-project [contenteditable]",this.$el).text(e)},Task.prototype.project_save=function(e){this.$el.attr("data-project-id",e);var r=this.board().record.project_records[e];if("undefined"==typeof r?this.project_update_title(""):this.project_update_title(r.title),e!=this.record.project_id){if("undefined"==typeof r)var t=text.task_removed_from_project.sprintf(this.board().current_user().record().short_name);else var t=text.task_added_to_project.sprintf(this.board().current_user().record().short_name,r.title);var o=this.record.project_id,s=this.board().record.project_records[o];"undefined"!=typeof s&&(t+=text.task_added_to_project_previous.sprintf(s.title)),this.record.project_id=e,this.save(t)}},Task.prototype.parse_project=function(){var e=this,r=$(".task-project [contenteditable]",this.$el);sanitize(r),strip_tags(r,[]);var t=r.html().replace(/\\/gi,"&#92;");if("undefined"!=typeof t&&""!==t&&null!==t){var o=null;for(var s in this.board().record.project_records){var a=this.board().record.project_records[s];if(t===$.trim(a.title)){o=a.id;break}}if(null!==o)return void this.project_save(o);var i=text.project_added.sprintf(this.board().current_user().record().short_name,t),d={action:"save_project",post_type:"kanban_project",kanban_nonce:$("#kanban_nonce").val(),project:{title:t,board_id:e.board().record.id()},comment:i};$.ajax({method:"POST",url:ajaxurl,data:d}).done(function(r){e.board().record.project_records[r.data.project.id]=r.data.project,e.project_save(r.data.project.id)})}},Task.prototype.log_work_hour=function(e){if(!this.board().current_user().has_cap("write"))return!1;var r={task:this.record,action:"add_task_hour",kanban_nonce:$("#kanban_nonce").val(),operator:e};$.ajax({method:"POST",url:ajaxurl,data:r})};